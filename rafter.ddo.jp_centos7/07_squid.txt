<<<<<<< HEAD
rafter.ddo.jp CentOS release 7.0 (Oracle VirtualBox)

Squid

1. パッケージ確認

   # rpm -qa | grep squid
   squid-3.3.8-12.el7_0.x86_64

   # systemctl enable squid
   ln -s '/usr/lib/systemd/system/squid.service' '/etc/systemd/system/multi-user.target.wants/squid.service'

   # systemctl restart squid

2. 単純なプロキシ構成

   # cat /etc/squid/squid.conf | egrep -v "(^#|^$)"
   acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
   acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
   acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
   acl localnet src fc00::/7       # RFC 4193 local private network range
   acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
   acl SSL_ports port 443
   acl Safe_ports port 80          # http
   acl Safe_ports port 21          # ftp
   acl Safe_ports port 443         # https
   acl Safe_ports port 70          # gopher
   acl Safe_ports port 210         # wais
   acl Safe_ports port 1025-65535  # unregistered ports
   acl Safe_ports port 280         # http-mgmt
   acl Safe_ports port 488         # gss-http
   acl Safe_ports port 591         # filemaker
   acl Safe_ports port 777         # multiling http
   acl CONNECT method CONNECT
   http_access deny !Safe_ports
   http_access deny CONNECT !SSL_ports
   http_access allow localhost manager
   http_access deny manager
   http_access allow localnet
   http_access allow localhost
   http_access deny all
   http_port 8080
   cache_dir ufs /var/spool/squid 100 16 256
   coredump_dir /var/spool/squid
   refresh_pattern ^ftp:           1440    20%     10080
   refresh_pattern ^gopher:        1440    0%      1440
   refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
   refresh_pattern .               0       20%     4320
   cache_mem 16 MB
   logformat squid %tl %6tr %>a %Ss/%03>Hs %<st %rm %ru %un %Sh/%<A %mt

3. 多段プロキシ

   割愛

4. 透過プロキシ

   1. 構成図

       +--------------------------------+
       |                                |
       |          The Internet          |
       |                                |
       +---------------+---------------+
                       |
                       |
                       | Untrust: 218.219.220.9/32
       +---------------+---------------+
       |                                |
       |          Netscreen-25          |
       |                                |
       +---------------+---------------+
                       | Trust: 192.168.1.1/24
                       |
                       | enp0s3: 192.168.1.108/24
       +---------------+---------------+
       |                                |
       |   rafter.ddo.jp 透過プロキシ   |
       |                                |
       +---------------+----------------+
                       | enp0s8: 192.168.56.108/24
                       |
                       | ローカルエリア接続 2: 192.168.56.131
       +---------------+---------------+
       |                                |
       |       arazi 検証用 XP 端末     |
       |                                |
       +--------------------------------+

   2. /etc/squid/squid.conf (透過プロキシ用設定 追加部分)

      # Transparent proxy
      acl enp0s8 src 192.168.56.0/24
      http_access allow enp0s8
      http_port 8080 transparent

   3. /proc/sys/net/ipv4/ip_forward 内容確認

      # cat /proc/sys/net/ipv4/ip_forward
      1

   4. iptables 設定
      
      # iptables -t nat -A PREROUTING -i enp0s8 -s 192.168.56.0/24 -p tcp --dport 80 -j REDIRECT --to-port 8080

   5. /etc/sysconfig/iptables

      # cat /etc/sysconfig/iptables
      # Generated by iptables-save v1.4.21 on Wed Nov 26 21:47:14 2014
      *nat
      :PREROUTING ACCEPT [0:0]
      :INPUT ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]
      :POSTROUTING ACCEPT [0:0]
      -A POSTROUTING -s 192.168.56.0/24 -o enp0s3 -j SNAT --to-source 192.168.1.108
      -A PREROUTING -s 192.168.56.0/24 -i enp0s8 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
      COMMIT
      # Completed on Wed Nov 26 21:47:14 2014
      # Generated by iptables-save v1.4.21 on Wed Nov 26 21:47:14 2014
      *filter
      :INPUT DROP [0:0]
      :FORWARD ACCEPT [145:9740]
      :OUTPUT ACCEPT [6590:4340814]
      :LOGGING - [0:0]
      -A INPUT -i lo -j ACCEPT
      -A INPUT -i enp0s8 -j ACCEPT
      -A INPUT -i enp0s3 -p icmp -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 21 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 53 -j ACCEPT
      -A INPUT -i enp0s3 -p udp -m udp --dport 53 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 5900 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 25,465,587 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 80,443 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 110,995 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 143,993 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 8080 -j ACCEPT
      -A INPUT -i enp0s3 -m state --state RELATED,ESTABLISHED -j ACCEPT
      -A INPUT -i enp0s3 -j LOGGING
      -A OUTPUT -d 218.216.185.65/32 -o enp0s3 -p tcp -m tcp --dport 80 -j DROP
      -A LOGGING -i enp0s3 -m limit --limit 3/hour -j LOG --log-prefix "[iptables DROP]:" --log-level 7
      -A LOGGING -i enp0s3 -j DROP
      COMMIT
      # Completed on Wed Nov 26 21:47:14 2014

=======
rafter.ddo.jp CentOS release 7.0 (Oracle VirtualBox)

Squid

1. パッケージ確認

   # rpm -qa | grep squid
   squid-3.3.8-12.el7_0.x86_64

   # systemctl enable squid
   ln -s '/usr/lib/systemd/system/squid.service' '/etc/systemd/system/multi-user.target.wants/squid.service'

   # systemctl restart squid

2. 単純なプロキシ構成

   # cat /etc/squid/squid.conf | egrep -v "(^#|^$)"
   acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
   acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
   acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
   acl localnet src fc00::/7       # RFC 4193 local private network range
   acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
   acl SSL_ports port 443
   acl Safe_ports port 80          # http
   acl Safe_ports port 21          # ftp
   acl Safe_ports port 443         # https
   acl Safe_ports port 70          # gopher
   acl Safe_ports port 210         # wais
   acl Safe_ports port 1025-65535  # unregistered ports
   acl Safe_ports port 280         # http-mgmt
   acl Safe_ports port 488         # gss-http
   acl Safe_ports port 591         # filemaker
   acl Safe_ports port 777         # multiling http
   acl CONNECT method CONNECT
   http_access deny !Safe_ports
   http_access deny CONNECT !SSL_ports
   http_access allow localhost manager
   http_access deny manager
   http_access allow localnet
   http_access allow localhost
   http_access deny all
   http_port 8080
   cache_dir ufs /var/spool/squid 100 16 256
   coredump_dir /var/spool/squid
   refresh_pattern ^ftp:           1440    20%     10080
   refresh_pattern ^gopher:        1440    0%      1440
   refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
   refresh_pattern .               0       20%     4320
   cache_mem 16 MB
   logformat squid %tl %6tr %>a %Ss/%03>Hs %<st %rm %ru %un %Sh/%<A %mt

3. 多段プロキシ

   割愛

4. 透過プロキシ

   1. 構成図

       +--------------------------------+
       |                                |
       |          The Internet          |
       |                                |
       +---------------+---------------+
                       |
                       |
                       | Untrust: 218.219.220.9/32
       +---------------+---------------+
       |                                |
       |          Netscreen-25          |
       |                                |
       +---------------+---------------+
                       | Trust: 192.168.1.1/24
                       |
                       | enp0s3: 192.168.1.108/24
       +---------------+---------------+
       |                                |
       |   rafter.ddo.jp 透過プロキシ   |
       |                                |
       +---------------+----------------+
                       | enp0s8: 192.168.56.108/24
                       |
                       | ローカルエリア接続 2: 192.168.56.131
       +---------------+---------------+
       |                                |
       |       arazi 検証用 XP 端末     |
       |                                |
       +--------------------------------+

   2. /etc/squid/squid.conf (透過プロキシ用設定 追加部分)

      # Transparent proxy
      acl enp0s8 src 192.168.56.0/24
      http_access allow enp0s8
      http_port 8080 transparent

   3. /proc/sys/net/ipv4/ip_forward 内容確認

      # cat /proc/sys/net/ipv4/ip_forward
      1

   4. iptables 設定
      
      # iptables -t nat -A PREROUTING -i enp0s8 -s 192.168.56.0/24 -p tcp --dport 80 -j REDIRECT --to-port 8080

   5. /etc/sysconfig/iptables

      # cat /etc/sysconfig/iptables
      # Generated by iptables-save v1.4.21 on Wed Nov 26 21:47:14 2014
      *nat
      :PREROUTING ACCEPT [0:0]
      :INPUT ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]
      :POSTROUTING ACCEPT [0:0]
      -A POSTROUTING -s 192.168.56.0/24 -o enp0s3 -j SNAT --to-source 192.168.1.108
      -A PREROUTING -s 192.168.56.0/24 -i enp0s8 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 8080
      COMMIT
      # Completed on Wed Nov 26 21:47:14 2014
      # Generated by iptables-save v1.4.21 on Wed Nov 26 21:47:14 2014
      *filter
      :INPUT DROP [0:0]
      :FORWARD ACCEPT [145:9740]
      :OUTPUT ACCEPT [6590:4340814]
      :LOGGING - [0:0]
      -A INPUT -i lo -j ACCEPT
      -A INPUT -i enp0s8 -j ACCEPT
      -A INPUT -i enp0s3 -p icmp -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 21 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 22 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 53 -j ACCEPT
      -A INPUT -i enp0s3 -p udp -m udp --dport 53 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m tcp --dport 5900 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 25,465,587 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 80,443 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 110,995 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 143,993 -j ACCEPT
      -A INPUT -i enp0s3 -p tcp -m multiport --dports 8080 -j ACCEPT
      -A INPUT -i enp0s3 -m state --state RELATED,ESTABLISHED -j ACCEPT
      -A INPUT -i enp0s3 -j LOGGING
      -A OUTPUT -d 218.216.185.65/32 -o enp0s3 -p tcp -m tcp --dport 80 -j DROP
      -A LOGGING -i enp0s3 -m limit --limit 3/hour -j LOG --log-prefix "[iptables DROP]:" --log-level 7
      -A LOGGING -i enp0s3 -j DROP
      COMMIT
      # Completed on Wed Nov 26 21:47:14 2014

>>>>>>> e6bea64517a0ae1f48fb3b493944504343180536
